<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¬ä¸¸è¿‘ä¾æ—¥å† - GitHubäº‘åŒæ­¥ç‰ˆ</title>
    <style>
        :root {
            --primary-red: #d32f2f;
            --paper-bg: #fcfaf2;
            --ink-black: #2c3e50;
            --gold: #fca311;
        }

        body {
            font-family: "æ¥·ä½“", "STKaiti", serif;
            background-color: var(--paper-bg);
            margin: 0; padding: 0;
            color: var(--ink-black);
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- æŠ½ç­¾åŒº --- */
        .draw-section {
            height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, #fffaf0 0%, #fcfaf2 100%);
            position: relative; text-align: center; padding: 0 20px; box-sizing: border-box;
        }

        #lotto-box {
            width: 140px; height: 180px;
            background: #8d6e63; border: 5px solid var(--ink-black);
            border-radius: 10px 10px 60px 60px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .shaking { animation: shake 0.15s infinite; }
        @keyframes shake {
            0% { transform: rotate(0); }
            25% { transform: rotate(-8deg) translate(-3px, -3px); }
            75% { transform: rotate(8deg) translate(3px, -3px); }
        }

        #result-display {
            font-size: 2rem; color: var(--primary-red);
            font-weight: bold; margin: 15px 0; min-height: 1.2em;
        }

        button#drawBtn {
            padding: 15px 40px; font-size: 1.5rem;
            background: var(--primary-red); color: white;
            border: none; border-radius: 60px; cursor: pointer;
            box-shadow: 0 6px #9a0007; transition: 0.1s;
        }
        button#drawBtn:active { transform: translateY(4px); box-shadow: 0 2px #9a0007; }

        /* --- ç®¡ç†åŒº --- */
        .manage-section {
            min-height: 100vh; padding: 30px 15px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            background: white; border-top: 2px solid var(--ink-black);
        }

        @media (max-width: 768px) {
            .manage-section { grid-template-columns: 1fr; }
        }

        .panel {
            border: 2px solid #efebe9; border-radius: 15px; padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* åŒæ­¥æ§ä»¶æ ·å¼ */
        .sync-panel {
            background: #f4f4f4; border: 2px dashed #ccc;
            margin-bottom: 20px; text-align: center;
            grid-column: 1 / -1;
        }
        .sync-input {
            width: 90%; max-width: 400px; padding: 10px; margin: 5px 0;
            border: 1px solid #ddd; border-radius: 5px; font-family: sans-serif;
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-day { 
            border: 1px solid #f5f5f5; padding: 4px; min-height: 50px; 
            font-size: 0.75rem; display: flex; flex-direction: column; align-items: center;
        }
        .calendar-header { font-weight: bold; padding: 5px; background: #fafafa; text-align: center; font-size: 0.8rem; }
        .has-result { background-color: #fffde7; }
        .attendant-name { color: var(--primary-red); font-weight: bold; font-size: 0.65rem; margin-top: 2px; text-align: center; word-break: break-all; }

        /* åå•æ ·å¼ */
        details { margin-bottom: 10px; border: 1px solid #eee; border-radius: 5px; }
        summary { padding: 12px; background: #fdfdfd; cursor: pointer; font-weight: bold; }
        .name-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; padding: 10px; }
        label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 6px; }

        h2 { border-left: 5px solid var(--primary-red); padding-left: 12px; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="draw-section">
    <h1 style="font-size: 2.2rem; margin: 0;">æœ¬ä¸¸è¿‘ä¾æŠ½é€‰</h1>
    <div id="lotto-box">ç­¾ç­’</div>
    <div id="result-display">å‡†å¤‡å”¤èµ·â€¦â€¦</div>
    <button id="drawBtn">èµ·æ‰‹æ‘‡ç­¾</button>
    <div style="margin-top: 20px; color: #aaa; font-size: 0.9rem;">â–½ å‘ä¸‹æ»šåŠ¨åŒæ­¥äº‘ç«¯ â–½</div>
</div>

<div class="manage-section">

    <div class="panel">
        <h2>å‡ºé˜µåå•</h2>
        <div id="nameContainer"></div>
    </div>

    <div class="panel">
        <h2 id="calendarTitle">å²ä¹¦è®°å½•</h2>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
	
    <div class="panel sync-panel">
        <h2>ğŸ™ GitHub Gist äº‘åŒæ­¥</h2>
        <input type="password" id="gistToken" class="sync-input" placeholder="ç²˜è´´ä½ çš„ GitHub Token (classic)">
        <input type="text" id="gistId" class="sync-input" placeholder="ç²˜è´´ä½ çš„ Gist ID">
        <div style="margin-top: 10px;">
            <button onclick="syncToGist()" style="padding: 10px 20px; background: #24292e; color:white; border:none; border-radius:5px; cursor:pointer;">ä¿å­˜åˆ°äº‘ç«¯</button>
            <button onclick="loadFromGist()" style="padding: 10px 20px; background: #28a745; color:white; border:none; border-radius:5px; margin-left:10px; cursor:pointer;">ä»äº‘ç«¯æ‹‰å–</button>
        </div>
        <p style="font-size: 0.7rem; color: #888; margin-top: 8px;">Token å’Œ ID å°†ä»…ä¿å­˜åœ¨æ­¤æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ä¸­ã€‚</p>
    </div>
</div>

<script>
    const data = {
        "çŸ­åˆ€": ["ä»ŠåŠ", "å¹³é‡è—¤å››éƒ", "åšè—¤å››éƒ", "å¾Œè—¤è—¤å››éƒ", "ä¿¡æ¿ƒè—¤å››éƒ", "å‰ç”°è—¤å››éƒ", "ç§‹ç”°è—¤å››éƒ", "åšå¤šè—¤å››éƒ", "ä¹±è—¤å››éƒ", "äº”è™é€€", "è—¥ç ”è—¤å››éƒ", "åŒ…ä¸è—¤å››éƒ", "æ„›æŸ“å›½ä¿Š", "å¤ªé¼“é˜è²å®—", "å°å¤œå·¦æ–‡å­—", "ä¸å‹•è¡Œå…‰", "æ¯›åˆ©è—¤å››éƒ", "è¬™ä¿¡æ™¯å…‰", "æ—¥å‘æ­£å®—", "åŒ—è°·èœåˆ‡", "å¤ªé–¤å·¦æ–‡å­—", "äº¬æ¥µæ­£å®—", "ä¹é¬¼æ­£å®—", "ä¿±åˆ©ä¼½ç¾…æ±Ÿ"],
        "è„‡å·®": ["ç¬‘é¢é’æ±Ÿ", "é¯°å°¾è—¤å››éƒ", "éª¨å–°è—¤å››éƒ", "ç‰©å‰è²å®—", "å €å·å›½åºƒ", "æµ¦å³¶è™å¾¹", "ç¯­æ‰‹åˆ‡æ±Ÿ", "è‚¥å‰å¿ åºƒ", "æ²»é‡‘ä¸¸", "æ³›å¡µ", "ç«è»Šåˆ‡"],
        "æ‰“åˆ€": ["é³´ç‹", "åƒå­æ‘æ­£", "äº€ç”²è²å®—", "å®—ä¸‰å·¦æ–‡å­—", "åŠ å·æ¸…å…‰", "å¤§å’Œå®ˆå®‰å®š", "æ­Œä»™å…¼å®š", "å’Œæ³‰å®ˆå…¼å®š", "é™¸å¥¥å®ˆå‰è¡Œ", "å±±å§¥åˆ‡å›½åºƒ", "èœ‚é ˆè³€è™å¾¹", "é•·æ›½ç¥¢è™å¾¹", "å¤§ä¿±åˆ©ä¼½ç¾…", "å£“åˆ‡é•·è°·éƒ¨", "åŒç”°è²«æ­£å›½", "å—æ³‰ä¸€æ–‡å­—", "å±±å§¥åˆ‡é•·ç¾©", "è±Šå‰æ±Ÿ", "å—æµ·å¤ªéƒæœå°Š", "æ¡‘åæ±Ÿ", "æ°´å¿ƒå­æ­£ç§€", "æºæ¸…éº¿", "æ¾äº•æ±Ÿ", "åœ°è—è¡Œå¹³", "äº”æœˆé›¨æ±Ÿ", "æ‘é›²æ±Ÿ", "ç¨»è‘‰æ±Ÿ", "çŸ³ç”°æ­£å®—", "å­«å…­å…¼å…ƒ", "å¾Œå®¶å…¼å…‰", "å¯Œç”°æ±Ÿ", "å¤§æ…¶ç›´èƒ¤", "å®‰å®…åˆ‡", "äºŒç­‹æ¨‹è²å®—"],
        "å¤ªåˆ€": ["ç«¥å­åˆ‡å®‰ç¶± å‰¥è½", "ä¸‰æ—¥æœˆå®—è¿‘", "å°ç‹ä¸¸", "å¤§å…¸å¤ªå…‰ä¸–", "é¨·é€Ÿä¹‹åŠ", "æ•°ç ä¸¸æ’æ¬¡", "é¬¼ä¸¸å›½ç¶±", "ä¸€æœŸä¸€æŒ¯", "å¤§åŒ…å¹³", "é¶¯ä¸¸", "æ˜çŸ³å›½è¡Œ", "ç‡­å°åˆ‡å…‰å¿ ", "å¤§èˆ¬è‹¥é•·å…‰", "å°é¾æ™¯å…‰", "æ±Ÿé›ªå·¦æ–‡å­—", "å±±ä¼å›½åºƒ", "é«­åˆ‡", "è†ä¸¸", "ç…å­ç‹", "å°çƒä¸¸", "æ‹”ä¸¸", "å°è±†é•·å…‰", "åƒä»£é‡‘ä¸¸", "å±±é³¥æ¯›", "å¤ä»Šå‚³æˆä¹‹å¤ªåˆ€", "æ—¥å…‰ä¸€æ–‡å­—", "ä¸€æ–‡å­—å‰‡å®—", "å§¬é¶´ä¸€æ–‡å­—", "ç¦å³¶å…‰å¿ ", "ç¬¹è²«", "å…«ä¸å¿µä½›", "å®Ÿä¼‘å…‰å¿ ", "é›²ç”Ÿ", "é“èª‰ä¸€æ–‡å­—", "é›²æ¬¡", "é¢å½±", "å¤å‚™å‰ä¿¡æˆ¿", "ä¸‰éƒå›½å®—"],
        "å¤§å¤ªåˆ€": ["çŸ³åˆ‡ä¸¸", "è¢ä¸¸", "å¤ªéƒå¤ªåˆ€", "æ¬¡éƒå¤ªåˆ€", "ç¥¢ç¥¢åˆ‡ä¸¸"],
        "è–™åˆ€": ["å²©è", "å·´å½¢è–™åˆ€", "éœå½¢è–™åˆ€"],
        "æª": ["èœ»è›‰åˆ‡", "æ—¥æœ¬å·", "å¾¡æ‰‹æµ", "å¤§åƒé³¥åæ–‡å­—æ§", "äººé–“ç„¡éª¨"],
        "å‰‘": ["ç™½å±±å‰å…‰", "ä¸ƒæ˜ŸåŠ", "ä¸™å­æ¤’æ—åŠ"]
    };

    const STORAGE_CHECK_KEY = "touken_checked_v1";
    const STORAGE_HISTORY_KEY = "touken_history_v1";
    const STORAGE_GIST_TOKEN = "touken_gist_token";
    const STORAGE_GIST_ID = "touken_gist_id";

    let historyData = JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY)) || {};
    let savedChecked = JSON.parse(localStorage.getItem(STORAGE_CHECK_KEY)) || null;

    // åˆå§‹åŒ–ç•Œé¢
    document.getElementById('gistToken').value = localStorage.getItem(STORAGE_GIST_TOKEN) || "";
    document.getElementById('gistId').value = localStorage.getItem(STORAGE_GIST_ID) || "";

    // 1. åˆå§‹åŒ–åå•
    const nameContainer = document.getElementById('nameContainer');
    for (let type in data) {
        const det = document.createElement('details');
        const sum = document.createElement('summary');
        sum.textContent = type;
        const grid = document.createElement('div');
        grid.className = 'name-grid';
        data[type].forEach(name => {
            const isChecked = savedChecked ? savedChecked.includes(name) : true;
            grid.innerHTML += `<label><input type="checkbox" class="name-cb" value="${name}" ${isChecked ? 'checked' : ''} onchange="saveSelection()"> ${name}</label>`;
        });
        det.appendChild(sum); det.appendChild(grid);
        nameContainer.appendChild(det);
    }

    function saveSelection() {
        const checked = Array.from(document.querySelectorAll('.name-cb:checked')).map(cb => cb.value);
        localStorage.setItem(STORAGE_CHECK_KEY, JSON.stringify(checked));
    }

    // 2. æ—¥å†ç³»ç»Ÿ
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="calendar-header">${d}</div>`);
        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = `${year}-${month+1}-${i}`;
            const winner = historyData[dateKey];
            grid.innerHTML += `<div class="calendar-day ${winner ? 'has-result' : ''}"><b>${i}</b>${winner ? `<span class="attendant-name">${winner}</span>` : ""}</div>`;
        }
    }

    // 3. æŠ½ç­¾é€»è¾‘
    const lottoBox = document.getElementById('lotto-box');
    const resultDisplay = document.getElementById('result-display');
    const drawBtn = document.getElementById('drawBtn');

    drawBtn.onclick = function() {
        const pool = Array.from(document.querySelectorAll('.name-cb:checked')).map(cb => cb.value);
        if (pool.length === 0) return alert("åå•ä¸ºç©ºï¼");
        drawBtn.disabled = true;
        resultDisplay.innerText = "æ­£åœ¨æ„Ÿåº”...";
        lottoBox.classList.add('shaking');
        setTimeout(() => {
            lottoBox.classList.remove('shaking');
            const winner = pool[Math.floor(Math.random() * pool.length)];
            resultDisplay.innerText = "ä»Šæ—¥è¿‘ä¾ï¼š" + winner;
            const d = new Date();
            const dateKey = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
            historyData[dateKey] = winner;
            localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(historyData));
            renderCalendar();
            drawBtn.disabled = false;
        }, 1200);
    };

    // 4. GitHub Sync æ ¸å¿ƒé€»è¾‘
    async function syncToGist() {
        const token = document.getElementById('gistToken').value;
        const id = document.getElementById('gistId').value;
        if(!token || !id) return alert("è¯·å…ˆå¡«å†™ Token å’Œ Gist ID");
        
        localStorage.setItem(STORAGE_GIST_TOKEN, token);
        localStorage.setItem(STORAGE_GIST_ID, id);

        const payload = {
            checked: localStorage.getItem(STORAGE_CHECK_KEY),
            history: localStorage.getItem(STORAGE_HISTORY_KEY),
            syncTime: new Date().toLocaleString()
        };

        try {
            const res = await fetch(`https://api.github.com/gists/${id}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { "touken_data.json": { content: JSON.stringify(payload) } } })
            });
            if(res.ok) alert("ğŸ‰ å·²ä¿å­˜è‡³äº‘ç«¯ï¼");
            else alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æƒé™æˆ– ID æ˜¯å¦æ­£ç¡®");
        } catch(e) { alert("ç½‘ç»œè¯·æ±‚å‡ºé”™"); }
    }

    async function loadFromGist() {
        const token = document.getElementById('gistToken').value;
        const id = document.getElementById('gistId').value;
        if(!token || !id) return alert("è¯·å…ˆå¡«å†™ Token å’Œ Gist ID");

        localStorage.setItem(STORAGE_GIST_TOKEN, token);
        localStorage.setItem(STORAGE_GIST_ID, id);

        try {
            const res = await fetch(`https://api.github.com/gists/${id}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if(res.ok) {
                const gist = await res.json();
                const content = JSON.parse(gist.files["touken_data.json"].content);
                localStorage.setItem(STORAGE_CHECK_KEY, content.checked);
                localStorage.setItem(STORAGE_HISTORY_KEY, content.history);
                alert("âœ… æ‹‰å–æˆåŠŸï¼Œå³å°†åˆ·æ–°é¡µé¢...");
                location.reload();
            } else { alert("æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®"); }
        } catch(e) { alert("ç½‘ç»œè¯·æ±‚å‡ºé”™"); }
    }

    renderCalendar();
</script>

</body>

</html>
