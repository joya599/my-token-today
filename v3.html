<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¬ä¸¸è¿‘ä¾æ—¥å† - å®Œç¾è§†è§‰æˆå°±ç‰ˆ</title>
    <style>
        :root {
            --primary-red: #d32f2f;
            --paper-bg: #fcfaf2;
            --ink-black: #2c3e50;
        }

        body {
            font-family: "æ¥·ä½“", "STKaiti", serif;
            background-color: var(--paper-bg);
            margin: 0; padding: 0;
            color: var(--ink-black);
            scroll-behavior: smooth;
            transition: background-color 1.5s ease;
        }

        /* --- æŠ½ç­¾åŒº --- */
        .draw-section {
            height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; text-align: center; padding: 0 20px; box-sizing: border-box;
        }

        #lotto-box {
            width: 140px; height: 180px;
            background: #8d6e63; border: 5px solid var(--ink-black);
            border-radius: 10px 10px 60px 60px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .shaking { animation: shake 0.15s infinite; }
        @keyframes shake {
            0% { transform: rotate(0); }
            25% { transform: rotate(-8deg) translate(-3px, -3px); }
            75% { transform: rotate(8deg) translate(3px, -3px); }
        }

        #result-display {
            font-size: 2.2rem; font-weight: bold; margin: 15px 0; min-height: 1.2em;
            transition: 0.3s;
        }

        button#drawBtn {
            padding: 15px 40px; font-size: 1.5rem;
            font-family: "æ¥·ä½“", "STKaiti", serif;
            background: var(--primary-red); color: white;
            border: none; border-radius: 60px; cursor: pointer;
            box-shadow: 0 6px rgba(0,0,0,0.25);
            transition: 0.2s;
        }
        button#drawBtn:active { transform: translateY(4px); box-shadow: 0 2px rgba(0,0,0,0.2); }

        /* å¿ƒæƒ…æ°”æ³¡æ ·å¼ */
        #mood-bubble {
            margin: 15px 0; padding: 8px 20px;
            border-radius: 20px; background: rgba(255,255,255,0.9);
            display: none; border: 1px solid #ddd;
            font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ¨±èŠ±ç‰¹æ•ˆ */
        .sakura {
            position: fixed; top: -20px; z-index: 9999;
            pointer-events: none; animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* --- ç®¡ç†åŒº --- */
        .manage-section {
            min-height: 100vh; padding: 30px 15px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            background: white; border-top: 2px solid var(--ink-black);
        }

        @media (max-width: 768px) { .manage-section { grid-template-columns: 1fr; } }

        .panel {
            border: 2px solid #efebe9; border-radius: 15px; padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); background: white;
        }

        /* æ—¥å†æ ¸å¿ƒæ ·å¼ä¼˜åŒ– */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-header { font-weight: bold; padding: 5px; background: #fafafa; text-align: center; font-size: 0.8rem; border-radius: 4px; }
        .calendar-day { 
            border: 1px solid #f5f5f5; padding: 0;
            min-height: 80px; 
            font-size: 0.75rem; display: flex; flex-direction: column; align-items: center;
            position: relative; overflow: hidden;
        }
        .calendar-day-accent { 
            width: 100%; height: 24px; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; margin-bottom: 4px;
        }
        .day-number-empty { height: 24px; display: flex; align-items: center; justify-content: center; color: #ccc; }
        .attendant-name { font-weight: bold; font-size: 0.95rem; padding: 2px; text-align: center; word-break: break-all; }

        /* --- å›¾é‰´åŒº --- */
        .collection-section {
            min-height: 100vh; padding: 40px 15px;
            background-color: var(--paper-bg);
            border-top: 3px double var(--ink-black);
        }
        .achievement-header { text-align: center; margin-bottom: 30px; }
        .mvp-badge {
            display: inline-block; padding: 10px 25px;
            background: var(--ink-black); color: #f1c40f;
            border-radius: 50px; font-size: 1.2rem; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .collection-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px; padding: 15px;
        }
        .collection-item {
            padding: 10px 5px; border: 1px solid #eee; border-radius: 6px;
            text-align: center; font-size: 0.9rem; font-weight: bold;
            background: #fff; color: #d0d0d0; transition: 0.4s;
        }
        .collection-item.unlocked { color: #fff; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* åå•æ ·å¼ */
        details { margin-bottom: 10px; border: 1px solid #eee; border-radius: 5px; }
        summary { padding: 12px; background: #fdfdfd; cursor: pointer; font-weight: bold; font-family: "æ¥·ä½“", "STKaiti", serif; }
        .name-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; padding: 10px; }
        label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        h2 { border-left: 5px solid var(--primary-red); padding-left: 12px; font-size: 1.2rem; }
        .sync-panel { background: #f4f4f4; border: 2px dashed #ccc; text-align: center; grid-column: 1 / -1; }
        .sync-input { width: 90%; max-width: 400px; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

<div class="draw-section">
    <h1 style="font-size: 2.2rem; margin: 0 0 40px 0; letter-spacing: 4px;">æœ¬ä¸¸è¿‘ä¾æŠ½é€‰</h1>
    <div id="lotto-box">ç­¾ç­’</div>
    <div id="result-display">å‡†å¤‡å”¤èµ·â€¦â€¦</div>
    <div id="mood-bubble">ğŸ è¯¢é—®è¿‘ä¾ä»Šæ—¥å¿ƒæƒ…</div>
    <button id="drawBtn">èµ·æ‰‹æ‘‡ç­¾</button>
    <div style="position: absolute; bottom: 30px; color: #aaa; font-size: 0.9rem; cursor: pointer;" 
         onclick="document.getElementById('manage').scrollIntoView({behavior:'smooth'})">â–½ å‘ä¸‹æ»šåŠ¨ç®¡ç†åå• â–½</div>
</div>

<div class="manage-section" id="manage">
    <div class="panel">
        <h2>å‡ºé˜µåå•</h2>
        <div id="nameContainer"></div>
    </div>
    <div class="panel">
        <h2 id="calendarTitle">å²ä¹¦è®°å½•</h2>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <div class="panel sync-panel">
        <h2>â›©ï¸ GitHub Gist äº‘åŒæ­¥</h2>
        <input type="password" id="gistToken" class="sync-input" placeholder="GitHub Token">
        <input type="text" id="gistId" class="sync-input" placeholder="Gist ID">
        <div style="margin-top: 10px;">
            <button onclick="syncToGist()" style="padding: 10px 25px; background: #24292e; color:white; border:none; border-radius:5px; cursor:pointer;">ä¿å­˜åˆ°äº‘ç«¯</button>
            <button onclick="loadFromGist()" style="padding: 10px 25px; background: #28a745; color:white; border:none; border-radius:5px; margin-left:10px; cursor:pointer;">ä»äº‘ç«¯æ‹‰å–</button>
        </div>
    </div>
</div>

<div class="collection-section">
    <div class="achievement-header">
        <div class="mvp-badge" id="monthMvp">æœ¬æœˆè¿‘ä¾ï¼šğŸŒ¸</div>
        <h1 style="letter-spacing: 5px;">æœ¬æœˆæˆå°±å›¾é‰´</h1>
        <p style="color: #666;">ï¼ˆæ¯æœˆè‡ªåŠ¨åˆ·æ–°å·²ç‚¹äº®çš„è¿‘ä¾ï¼‰</p>
    </div>
    <div id="collectionContainer"></div>
</div>

<script>
    const COLORS = { "ä¸‰æ—¥æœˆå®—è¿‘":"#274b85", "å°ç‹ä¸¸":"#d6b214", "çŸ³åˆ‡ä¸¸":"#789658", "å²©è":"#74288a", "ä»ŠåŠ":"#e94c5f", "å¤§å…¸å¤ªå…‰ä¸–":"#6b7386", "é¨·é€Ÿä¹‹åŠ":"#f6ea86", "æ•°ç ä¸¸æ’æ¬¡":"#474398", "ç¬‘é¢é’æ±Ÿ":"#61816a", "é¬¼ä¸¸å›½ç¶±":"#27314c", "é³´ç‹":"#fff3c1", "ä¸€æœŸä¸€æŒ¯":"#72b6b5", "é¯°å°¾è—¤å››éƒ":"#5e3766", "éª¨å–°è—¤å››éƒ":"#b6adbe", "å¹³é‡è—¤å››éƒ":"#7c6659", "åšè—¤å››éƒ":"#b9b1af", "å¾Œè—¤è—¤å››éƒ":"#a87059", "ä¿¡æ¿ƒè—¤å››éƒ":"#ab1f2a", "å‰ç”°è—¤å››éƒ":"#a99477", "ç§‹ç”°è—¤å››éƒ":"#ef9499", "åšå¤šè—¤å››éƒ":"#ca661b", "ä¹±è—¤å››éƒ":"#ecba99", "äº”è™é€€":"#e8e0cd", "è—¥ç ”è—¤å››éƒ":"#8e6881", "åŒ…ä¸è—¤å››éƒ":"#b5948f", "æ¯›åˆ©è—¤å››éƒ":"#a7c57f", "ç™½å±±å‰å…‰":"#9cbfdf", "å¤§åŒ…å¹³":"#742b36", "é¶¯ä¸¸":"#748457", "å…«ä¸å¿µä½›":"#29479d", "å¤å‚™å‰ä¿¡æˆ¿":"#BF7F1F", "æ˜çŸ³å›½è¡Œ":"#393a3c", "è¢ä¸¸":"#a9c463", "çˆ±æŸ“å›½ä¿Š":"#db4135", "é¢å½±":"#BB94C0", "åƒå­æ‘æ­£":"#e3b6d3", "èœ»è›‰åˆ‡":"#95397a", "ç‰©å‰è²å®—":"#e7a58b", "å¤ªé¼“é˜è²å®—":"#2967b0", "é¾œç”²è²å®—":"#d0355f", "äºŒç­‹æ¨‹è²å®—":"#304878", "ç‡­å°åˆ‡å…‰å¿ ":"#435b73", "å¤§èˆ¬è‹¥é•·å…‰":"#771218", "å°é¾æ™¯å…‰":"#006591", "è¬™ä¿¡æ™¯å…‰":"#00469b", "å°è±†é•·å…‰":"#6f1838", "ç¦å³¶å…‰å¿ ":"#313a65", "å®Ÿä¼‘å…‰å¿ ":"#644388", "å¾Œå®¶å…¼å…‰":"#D9919c", "å®‰å®…åˆ‡":"#363545", "å±±å§¥åˆ‡é•·ç¾©":"#a3b4d2", "æ±Ÿé›ªå·¦æ–‡å­—":"#d7ebec", "å®—ä¸‰å·¦æ–‡å­—":"#cb858d", "å°å¤œå·¦æ–‡å­—":"#2686ae", "å¤ªé–¤å·¦æ–‡å­—":"#f6f4c4", "æ­Œä»™å…¼å®š":"#644f6d", "å’Œæ³‰å®ˆå…¼å®š":"#8a272a", "äººé—´æ— éª¨":"#a7a7c3", "å±±å§¥åˆ‡å›½å¹¿":"#46677a", "å±±ä¼å›½å¹¿":"#c2802c", "å €å·å›½å¹¿":"#5bacc7", "èœ‚é ˆè³€è™å¾¹":"#bc84ab", "æµ¦å³¶è™å¾¹":"#f49d00", "é•¿æ›¾ç¥¢è™å½»":"#504f4b", "å¤§ä¿±åˆ©ä¼½ç½—":"#94442b", "ç«è½¦åˆ‡":"#cf3b2d", "ç¬¼æ‰‹åˆ‡æ±Ÿ":"#495e37", "ä¸°å‰æ±Ÿ":"#d0273d", "æ¡‘åæ±Ÿ":"#f8b300", "æ¾äº•æ±Ÿ":"#0b80a3", "äº”æœˆé›¨æ±Ÿ":"#70549f", "æ‘äº‘æ±Ÿ":"#ef9098", "ç¨»å¶æ±Ÿ":"#3c403f", "å¯Œç”°æ±Ÿ":"#E7DCB0", "ä¿±åˆ©ä¼½ç¾…æ±Ÿ":"#8E8A89", "æ—¥å‘æ­£å®—":"#a31d3d", "çŸ³ç”°æ­£å®—":"#d8e1ce", "äº¬æ¥µæ­£å®—":"#5f001e", "ä¹é¬¼æ­£å®—":"#e7ebf4", "å—æ³‰ä¸€æ–‡å­—":"#f6ca81", "å±±é³¥æ¯›":"#b5bdc8", "æ—¥å…‰ä¸€æ–‡å­—":"#5e3f85", "ä¸€æ–‡å­—å‰‡å®—":"#da1c1e", "å§¬é¶´ä¸€æ–‡å­—":"#3c4451", "é“èª‰ä¸€æ–‡å­—":"#631022", "å¤ä»Šå‚³æˆä¹‹å¤ªåˆ€":"#f1cdc1", "åœ°è—è¡Œå¹³":"#517897", "äº‘ç”Ÿ":"#3FB9BE", "äº‘æ¬¡":"#F18d01", "ç«¥å­åˆ‡å®‰ç¶± å‰¥è½":"#BDBCBD", "åŠ å·æ¸…å…‰":"#a73d51", "å¤§å’Œå®ˆå®‰å®š":"#4485c7", "é™¸å¥¥å®ˆå‰è¡Œ":"#b14322", "é«­åˆ‡":"#e7dfb0", "è†ä¸¸":"#bbd6c3", "å£“åˆ‡é•·è°·éƒ¨":"#584a6d", "ä¸åŠ¨è¡Œå…‰":"#6f6798", "ç…å­ç‹":"#c0ac4d", "å°çƒä¸¸":"#cf111b", "æ‹”ä¸¸":"#c31c25", "åŒç”°è²«æ­£å›½":"#90817e", "é¶´ä¸¸å›½æ°¸":"#d7d9d8", "å¤ªéƒå¤ªåˆ€":"#69367F", "æ¬¡éƒå¤ªåˆ€":"#404d60", "æ—¥æœ¬å·":"#38394b", "å¾¡æ‰‹æµ":"#4b543f", "å·´å½¢è–™åˆ€":"#92cce0", "é™å½¢è–™åˆ€":"#d52317", "åƒä»£é‡‘ä¸¸":"#00aec9", "ç¥¢ç¥¢åˆ‡ä¸¸":"#7d2231", "å—æµ·å¤ªéƒæœå°Š":"#283555", "è‚¥å‰å¿ åºƒ":"#5f1013", "åŒ—è°·èœåˆ‡":"#f391c3", "æ°´å¿ƒå­æ­£ç§€":"#a89fce", "æºæ¸…éº¿":"#4b266b", "æ²»é‡‘ä¸¸":"#f9cd46", "å¤§åƒé³¥åæ–‡å­—æ§":"#ab9997", "æ³›å¡µ":"#ef9098", "ä¸ƒæ˜ŸåŠ":"#1c1b20", "ä¸™å­æ¤’æ—åŠ":"#7e7eba", "ç¬¹è²«":"#396122", "å­™å…­å…¼å…ƒ":"#464147", "å¤§åº†ç›´èƒ¤":"#4b3f81", "ä¸‰éƒå›½å®—":"#D61518" };
    const data = { "çŸ­åˆ€": ["ä»ŠåŠ", "å¹³é‡è—¤å››éƒ", "åšè—¤å››éƒ", "å¾Œè—¤è—¤å››éƒ", "ä¿¡æ¿ƒè—¤å››éƒ", "å‰ç”°è—¤å››éƒ", "ç§‹ç”°è—¤å››éƒ", "åšå¤šè—¤å››éƒ", "ä¹±è—¤å››éƒ", "äº”è™é€€", "è—¥ç ”è—¤å››éƒ", "åŒ…ä¸è—¤å››éƒ", "çˆ±æŸ“å›½ä¿Š", "å¤ªé¼“é˜è²å®—", "å°å¤œå·¦æ–‡å­—", "ä¸åŠ¨è¡Œå…‰", "æ¯›åˆ©è—¤å››éƒ", "è¬™ä¿¡æ™¯å…‰", "æ—¥å‘æ­£å®—", "åŒ—è°·èœåˆ‡", "å¤ªé–¤å·¦æ–‡å­—", "äº¬æ¥µæ­£å®—", "ä¹é¬¼æ­£å®—", "ä¿±åˆ©ä¼½ç¾…æ±Ÿ"], "è„‡å·®": ["ç¬‘é¢é’æ±Ÿ", "é¯°å°¾è—¤å››éƒ", "éª¨å–°è—¤å››éƒ", "ç‰©å‰è²å®—", "å €å·å›½å¹¿", "æµ¦å³¶è™å¾¹", "ç¯­æ‰‹åˆ‡æ±Ÿ", "è‚¥å‰å¿ åºƒ", "æ²»é‡‘ä¸¸", "æ³›å¡µ", "ç«è»Šåˆ‡"], "æ‰“åˆ€": ["é³´ç‹", "åƒå­æ‘æ­£", "äº€ç”²è²å®—", "å®—ä¸‰å·¦æ–‡å­—", "åŠ å·æ¸…å…‰", "å¤§å’Œå®ˆå®‰å®š", "æ­Œä»™å…¼å®š", "å’Œæ³‰å®ˆå…¼å®š", "é™¸å¥¥å®ˆå‰è¡Œ", "å±±å§¥åˆ‡å›½å¹¿", "èœ‚é ˆè³€è™å¾¹", "é•¿æ›¾ç¥¢è™å½»", "å¤§ä¿±åˆ©ä¼½ç½—", "å£“åˆ‡é•·è°·éƒ¨", "åŒç”°è²«æ­£å›½", "å—æ³‰ä¸€æ–‡å­—", "å±±å§¥åˆ‡é•·ç¾©", "è±Šå‰æ±Ÿ", "å—æµ·å¤ªéƒæœå°Š", "æ¡‘åæ±Ÿ", "æ°´å¿ƒå­æ­£ç§€", "æºæ¸…éº¿", "æ¾äº•æ±Ÿ", "åœ°è—è¡Œå¹³", "äº”æœˆé›¨æ±Ÿ", "æ‘é›²æ±Ÿ", "ç¨»è‘‰æ±Ÿ", "çŸ³ç”°æ­£å®—", "å­«å…­å…¼å…ƒ", "å¾Œå®¶å…¼å…‰", "å¯Œç”°æ±Ÿ", "å¤§æ…¶ç›´èƒ¤", "å®‰å®…åˆ‡", "äºŒç­‹æ¨‹è²å®—"], "å¤ªåˆ€": ["ç«¥å­åˆ‡å®‰ç¶± å‰¥è½", "ä¸‰æ—¥æœˆå®—è¿‘", "å°ç‹ä¸¸", "å¤§å…¸å¤ªå…‰ä¸–", "é¨·é€Ÿä¹‹åŠ", "æ•°ç ä¸¸æ’æ¬¡", "é¬¼ä¸¸å›½ç¶±", "ä¸€æœŸä¸€æŒ¯", "å¤§åŒ…å¹³", "é¶¯ä¸¸", "æ˜çŸ³å›½è¡Œ", "ç‡­å°åˆ‡å…‰å¿ ", "å¤§èˆ¬è‹¥é•·å…‰", "å°é¾æ™¯å…‰", "æ±Ÿé›ªå·¦æ–‡å­—", "å±±ä¼å›½å¹¿", "é«­åˆ‡", "è†ä¸¸", "ç…å­ç‹", "å°çƒä¸¸", "æ‹”ä¸¸", "å°è±†é•·å…‰", "åƒä»£é‡‘ä¸¸", "å±±é³¥æ¯›", "å¤ä»Šå‚³æˆä¹‹å¤ªåˆ€", "æ—¥å…‰ä¸€æ–‡å­—", "ä¸€æ–‡å­—å‰‡å®—", "å§¬é¶´ä¸€æ–‡å­—", "ç¦å³¶å…‰å¿ ", "ç¬¹è²«", "å…«ä¸å¿µä½›", "å®Ÿä¼‘å…‰å¿ ", "äº‘ç”Ÿ", "é“èª‰ä¸€æ–‡å­—", "äº‘æ¬¡", "é¢å½±", "å¤å¤‡å‰ä¿¡æˆ¿", "ä¸‰éƒå›½å®—"], "å¤§å¤ªåˆ€": ["çŸ³åˆ‡ä¸¸", "è¤ä¸¸", "å¤ªéƒå¤ªåˆ€", "æ¬¡éƒå¤ªåˆ€", "ç¥¢ç¥¢åˆ‡ä¸¸"], "è–™åˆ€": ["å²©è", "å·´å½¢è–™åˆ€", "é™å½¢è–™åˆ€"], "æª": ["èœ»è›‰åˆ‡", "æ—¥æœ¬å·", "å¾¡æ‰‹æµ", "å¤§åƒé³¥åæ–‡å­—æ§", "äººé—´æ— éª¨"], "å‰‘": ["ç™½å±±å‰å…‰", "ä¸ƒæ˜ŸåŠ", "ä¸™å­æ¤’æ—åŠ"] };

    const STORAGE_CHECK_KEY = "touken_checked_v1";
    const STORAGE_HISTORY_KEY = "touken_history_v1";
    const STORAGE_GIST_TOKEN = "touken_gist_token"; // æ–°å¢ï¼šä¿å­˜Tokençš„Key
    const STORAGE_GIST_ID = "touken_gist_id";       // æ–°å¢ï¼šä¿å­˜IDçš„Key

    let historyData = JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY)) || {};
    let savedChecked = JSON.parse(localStorage.getItem(STORAGE_CHECK_KEY)) || null;

    const MOODS = [
        { text: "ğŸŒ¸ æ¨±å¹é›ªï¼èº«ä½“è½»ç›ˆï¼ŒçŠ¶æ€ç»ä½³ï¼", effect: "sakura" },
        { text: "ğŸ± å¾ˆæœ‰å¹²åŠ²å‘¢ï¼å®‰æ’æˆ‘å»å†…ç•ªå§ï¼", effect: "none" },
        { text: "ğŸ’¤ ç¨å¾®æœ‰ç‚¹çŠ¯å›°ï¼Œæƒ³åˆç¡ä¸€ä¼šã€‚", effect: "none" },
        { text: "ğŸ—ºï¸ å¶å°”ä¹Ÿæƒ³å»è¿œå¾çœ‹çœ‹å¤–é¢çš„ä¸–ç•Œå‘¢ã€‚", effect: "shake" }
    ];

    // åˆå§‹åŒ–ç•Œé¢
    const nameContainer = document.getElementById('nameContainer');
    const collectionContainer = document.getElementById('collectionContainer');

    // è‡ªåŠ¨å¡«å……ä¿å­˜è¿‡çš„ Gist ä¿¡æ¯
    document.getElementById('gistToken').value = localStorage.getItem(STORAGE_GIST_TOKEN) || "";
    document.getElementById('gistId').value = localStorage.getItem(STORAGE_GIST_ID) || "";

    for (let type in data) {
        const det = document.createElement('details');
        const sum = document.createElement('summary');
        sum.textContent = type;
        const grid = document.createElement('div');
        grid.className = 'name-grid';
        data[type].forEach(name => {
            const isChecked = savedChecked ? savedChecked.includes(name) : true;
            grid.innerHTML += `<label><input type="checkbox" class="name-cb" value="${name}" ${isChecked ? 'checked' : ''} onchange="saveSelection()"> ${name}</label>`;
        });
        det.appendChild(sum); det.appendChild(grid);
        nameContainer.appendChild(det);

        const collDet = document.createElement('details'); collDet.open = true;
        const collSum = document.createElement('summary'); collSum.textContent = type;
        const collGrid = document.createElement('div'); collGrid.className = 'collection-grid'; collGrid.id = `coll-${type}`;
        collDet.appendChild(collSum); collDet.appendChild(collGrid);
        collectionContainer.appendChild(collDet);
    }

    function saveSelection() {
        const checked = Array.from(document.querySelectorAll('.name-cb:checked')).map(cb => cb.value);
        localStorage.setItem(STORAGE_CHECK_KEY, JSON.stringify(checked));
    }

    function renderEverything() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const now = new Date();
        const curYear = now.getFullYear();
        const curMonth = now.getMonth() + 1;
        const daysInMonth = new Date(curYear, curMonth, 0).getDate();
        const monthCounts = {};
        const monthUnlocked = new Set();
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="calendar-header">${d}</div>`);
        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = `${curYear}-${curMonth}-${i}`;
            const winner = historyData[dateKey];
            const color = COLORS[winner] || "transparent";
            if(winner) { monthCounts[winner] = (monthCounts[winner] || 0) + 1; monthUnlocked.add(winner); }
            grid.innerHTML += `<div class="calendar-day" style="background-color: ${winner ? color + '10' : 'white'}">${winner ? `<div class="calendar-day-accent" style="background-color: ${color}">${i}</div>` : `<div class="day-number-empty">${i}</div>`}${winner ? `<span class="attendant-name">${winner}</span>` : ""}</div>`;
        }
        updateMvp(monthCounts);
        updateCollection(monthUnlocked);
    }

    function updateMvp(counts) {
        const entries = Object.entries(counts);
        if (entries.length === 0) { document.getElementById('monthMvp').innerText = "æœ¬æœˆè¿‘ä¾ï¼šğŸŒ¸"; return; }
        const max = Math.max(...Object.values(counts));
        const mvps = entries.filter(e => e[1] === max && max > 1);
        document.getElementById('monthMvp').innerText = mvps.length > 0 ? `æœ¬æœˆè¿‘ä¾ï¼š${mvps.map(e => e[0]).join('ã€')}` : "æœ¬æœˆè¿‘ä¾ï¼šğŸŒ¸";
    }

    function updateCollection(unlockedSet) {
        for (let type in data) {
            const grid = document.getElementById(`coll-${type}`);
            grid.innerHTML = "";
            data[type].forEach(name => {
                const isUnlocked = unlockedSet.has(name);
                const color = COLORS[name] || "#333";
                grid.innerHTML += `<div class="collection-item ${isUnlocked ? 'unlocked' : ''}" style="${isUnlocked ? `background-color:${color}` : ''}">${name}</div>`;
            });
        }
    }

    const drawBtn = document.getElementById('drawBtn');
    const moodBubble = document.getElementById('mood-bubble');

    drawBtn.onclick = function() {
        const pool = Array.from(document.querySelectorAll('.name-cb:checked')).map(cb => cb.value);
        if (pool.length === 0) return alert("åå•ä¸ºç©ºï¼");
        drawBtn.disabled = true;
        document.getElementById('result-display').innerText = "æ­£åœ¨æ„Ÿåº”...";
        moodBubble.style.display = 'none';
        document.getElementById('lotto-box').classList.add('shaking');
        setTimeout(() => {
            document.getElementById('lotto-box').classList.remove('shaking');
            const winner = pool[Math.floor(Math.random() * pool.length)];
            const color = COLORS[winner] || "#d32f2f";
            document.body.style.backgroundColor = color + "1a"; 
            document.getElementById('result-display').innerText = "ä»Šæ—¥è¿‘ä¾ï¼š" + winner;
            document.getElementById('result-display').style.color = color;
            drawBtn.style.backgroundColor = color;
            const d = new Date();
            historyData[`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`] = winner;
            localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(historyData));
            renderEverything();
            drawBtn.disabled = false;
            moodBubble.style.display = 'inline-block';
            moodBubble.innerText = "ğŸ è¯¢é—®è¿‘ä¾ä»Šæ—¥å¿ƒæƒ…";
            moodBubble.onclick = () => getMood(winner);
        }, 1200);
    };

    function getMood(winner) {
        const randomMood = MOODS[Math.floor(Math.random() * MOODS.length)];
        moodBubble.innerText = randomMood.text;
        moodBubble.onclick = null;
        if (randomMood.effect === "sakura") createSakura();
        if (randomMood.effect === "shake") {
            const res = document.getElementById('result-display');
            res.style.transform = "scale(1.2)";
            setTimeout(() => res.style.transform = "scale(1)", 500);
        }
    }

    function createSakura() {
        for (let i = 0; i < 35; i++) {
            const s = document.createElement('div');
            s.className = 'sakura'; s.innerHTML = 'ğŸŒ¸';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.fontSize = (Math.random() * 15 + 10) + 'px';
            s.style.opacity = Math.random();
            s.style.animationDuration = (Math.random() * 3 + 2) + 's';
            document.body.appendChild(s);
            setTimeout(() => s.remove(), 5000);
        }
    }

    // --- åŒæ­¥é€»è¾‘ä¼˜åŒ–ï¼šæ–°å¢ä¿å­˜ Token å’Œ ID çš„åŠŸèƒ½ ---
    function saveGistCredentials(t, i) {
        localStorage.setItem(STORAGE_GIST_TOKEN, t);
        localStorage.setItem(STORAGE_GIST_ID, i);
    }

    async function syncToGist() {
        const t = document.getElementById('gistToken').value;
        const i = document.getElementById('gistId').value;
        if(!t || !i) return alert("é…ç½®ç¼ºå¤±");
        
        saveGistCredentials(t, i); // ä¿å­˜åˆ°æœ¬åœ°è®°å¿†

        const res = await fetch(`https://api.github.com/gists/${i}`, {
            method: 'PATCH', headers: { 'Authorization': `token ${t}` },
            body: JSON.stringify({ files: { "touken_data.json": { content: JSON.stringify({ checked: localStorage.getItem(STORAGE_CHECK_KEY), history: localStorage.getItem(STORAGE_HISTORY_KEY) }) } } })
        });
        if(res.ok) alert("ğŸ‰ å·²åŒæ­¥è‡³äº‘ç«¯");
        else alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tokenæˆ–IDæ˜¯å¦æ­£ç¡®");
    }

    async function loadFromGist() {
        const t = document.getElementById('gistToken').value;
        const i = document.getElementById('gistId').value;
        if(!t || !i) return alert("é…ç½®ç¼ºå¤±");

        saveGistCredentials(t, i); // ä¿å­˜åˆ°æœ¬åœ°è®°å¿†

        const res = await fetch(`https://api.github.com/gists/${i}`, { headers: { 'Authorization': `token ${t}` } });
        if(res.ok) {
            const g = await res.json(); 
            const c = JSON.parse(g.files["touken_data.json"].content);
            localStorage.setItem(STORAGE_CHECK_KEY, c.checked); 
            localStorage.setItem(STORAGE_HISTORY_KEY, c.history);
            location.reload();
        } else {
            alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®");
        }
    }

    renderEverything();
</script>
</body>
</html>
